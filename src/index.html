<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width= device-width, intial-scale=1">
        
        <!--Title-->
        <title>Space Dopers</title>

        <!--Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
         <link rel="stylesheet" href="services.css">

        <style>


        </style>
        
    </head>
    <body>
     <nav>
            <img src="images/Logo.png" alt="Your Startup Logo" class="logo">
            <ul>
                <li><a href="landing.html">Home page</a></li>
                <li><a href="login.html">Login</a></li>
                <li><a href="sign_up.html">Sign up</a></li>
                <li><a href="#signup">About us</a></li>

            </ul>
      </nav>
      <div id="loggedin">
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
      
      <div class="signup-container">
        <h2>Sign Up</h2>
        <form onsubmit="App.registerUser(); return false;" id="signupForm">
            <label for="register_username">User Name:</label>
            <input type="text" id="register_username" name="name" required pattern="[A-Za-z ]+" title="Name should consist of letters only">

            <label for="register_password">Password:</label>
            <input type="password" id="register_password" name="password">

            <button type="submit" value="Signup">Sign Up</button>
        </form>
    </div>
    <div class="login-container">
      <h2>Login</h2>
      <form onsubmit="App.loginUser(); return false;">
          <label for="login_username">Username:</label>
          <input type="text" id="login_username" name="username" placeholder="Enter your username or email">

          <label for="login_password">Password:</label>
          <input type="password" id="login_password" name="password" placeholder="Enter your password" required>

          <button type="submit" value="Login">Login</button>
      </form>
    </div>
  </div>
   
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        
          <div class="container-fluid">
            <div class="row">
              <main role="main" class="col-lg-12 d-flex justify-content-center">
                <!--<div id="loader" class="text-center">
                  <p class="text-center">Loading...</p>
                </div>-->
                <div id="content">
                  <h3>Account </h3>
                  <span id="account"></span>
                  <form onsubmit="App.createUser(); return false;">
                    <label>Name:</label><br>
                    <input type="text" id="newUser_name"><br>
                    
                    <input type="submit" value="Add">
                                  
                  </form>
               
    		<section class="services-container">
    		<div class="upload-section" id="afterLogin">
    		<h2>Upload Your File</h2>
                  <input type = "file" id = "fileInput" required />
                  <button onclick="uploadFile()" class="submit-button" >Upload File</button>
                  <br>
                  
                  <p id= 'cid_html'> CID of Uploaded file is shown here.. </p>
                  </div>
                  <br><br>
                  <div class="cid-section">
                  <h2>Enter CID Number</h2>
                  <label for="cidInput"></label>
                  <input type="text" id="cidInput" />
                  <button onclick="retrieveFile()" class="submit-button">Retrieve File</button>
                  <p id = 'filedata_html'>Retrived file data is shown here..</p>
                  </div>
                  
                  </section> 
                  
                  <ul id="userList" class="list-unstyled">
                    <div class="userTemplate" class="text" style="display: none">
                      <label>
                        
                        <span class="content">User List goes here...</span>
                      </label>
                    </div>
                  </ul>
                  <ul id="joinedUserList" class="list-unstyled">
                  </ul>
                </div>
              </main>
            </div>
        </div>
        <div id="afterLogin">
          <button onclick="App.logout()">Logout</button>
      </div>
        <h1>Crypto Payment </h1>

        <button onclick="App.transfer()">Pay</button>
</script>

        <script src="https://unpkg.com/ipfs-http-client/dist/index.min.js"></script>
        
	<script>
	const ipfs = window.IpfsHttpClient.create('http://localhost:5001');

	async function uploadFile() {
  	const fileInput = document.getElementById('fileInput');
  	console.log("file input: ",fileInput);
  	
  	const file = fileInput.files[0];
  	console.log("file: ",file);
  	
  	const fileName = file.name;
  	console.log(fileName);
  	
  	const fileContent = await readFileContent(file);
        console.log('File Content:', fileContent);
        
  	if(file){
  		try{
  			const fileData = new FormData();
  			fileData.append('file', file);
  			
  			const addedFile = await ipfs.add({ path: fileName, content: fileContent })
  			console.log('Added Files:', addedFile);
  		
  			const cid = addedFile.cid.toString();
  			document.getElementById("cid_html").innerHTML = cid;
  			console.log('File uploaded to IPFS with CID:', cid);
  			
  			
  		}catch (error) {
  			console.warn('Check if files are selected');
  			console.error('Error uploading File', error);
  			return null;
  		}
  		
  	} else{
  		console.warn('No files selected');
  	}

}
	async function retrieveFile(){
		const cidInput = document.getElementById('cidInput');
		const cid = cidInput.value.trim();
		
		if(cid){
			try{
				const response = await ipfs.cat(cid);
				
				const chunks = [];
        			for await (const chunk of response) {
            				chunks.push(...chunk);
        			}
        			

        			// Decode the Buffer or Uint8Array to text
        			const content = String.fromCharCode(...chunks);
        			document.getElementById("filedata_html").innerHTML = content;
        			console.log('File content from IPFS:', content);
				
			}catch (error){
				console.error('Error retrieving File from IPFS: ', error);		
			}
			
		}else {
			console.warn('CID is required');
		}
	}
	
	function readFileContent(file) {
    		return new Promise((resolve, reject) => {
        		const reader = new FileReader();

        		// Set up event listener for when the file reading is complete
        		reader.onloadend = () => {
            		const content = reader.result;
            		resolve(content);
        };

        	// Set up event listener for errors during file reading
        	reader.onerror = (error) => {
            		reject(error);
        };

        	// Read the file content as text
        	reader.readAsText(file);
    });
}
	
	/*async function addFileToIPFS(file) {
	  	const fileData = new FormData();
	  	fileData.append('file', file);
		console.log("File data", fileData);
	  	const addedFile = await ipfs.addAll(fileData);
	  	console.log('Added Files:', addedFile);
	  	if(addedFile && addedFile.length>0){
	  	const cid = addedFile[0].cid.toString();
	  	return cid;
	  	}else{
	  	 console.log('No files added');
	  	 return null;
	  	}
}

	async function retrieveFileFromIPFS(cid) {
  		const data = await ipfs.cat(cid);
  		return data;
	}*/

	
	</script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="vendor/web3/dist/web3.js"></script>
        <script src="vendor/truffle-contract/dist/truffle-contract.js"></script>

        <script src="app.js"></script>
        
    </body>
</html>
